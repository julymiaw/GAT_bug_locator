# 仓库介绍

## 运行步骤

```shell
# 将类级别的文件依赖图保存为文件级别
python save_graph_fold_dataframes.py {file_prefix}

# 将数据载入内存
python load_data_to_joblib_memmap.py {file_prefix}

# 评估数据集的依赖边数与连通情况
python evaluate_dataset.py {file_prefix}

# 训练模型
python train_adaptive_GAT.py {file_prefix}

# 评估模型
python evaluator.py {log_dir}
```

## 数据集评估结果

### AspectJ数据集的图结构和消息传播特性评估结果

1. 基本统计

    | 指标              | 数值  |
    | ----------------- | ----- |
    | 总bug数           | 576   |
    | 总文件数          | 19340 |
    | 修复文件比例      | 0.12% |
    | 平均每个bug的边数 | 11752 |

2. 图结构特性

    | 指标             | 均值     | 标准差  |
    | ---------------- | -------- | ------- |
    | 节点数量         | 2325.76  | 692.24  |
    | 边数量           | 11846.05 | 3980.96 |
    | 图密度           | 0.0047   | 0.0015  |
    | 修复文件数       | 2.91     | 6.14    |
    | 连通分量数       | 18.28    | 6.10    |
    | 最大连通分量大小 | 2308.49  | 696.27  |
    | 平均路径长度     | 2.50     | 0.07    |
    | 消息传递效率     | 0.40     | 0.01    |

3. 消息传播特性

    | 指标                 | 数值  |
    | -------------------- | ----- |
    | 到修复文件的平均跳数 | 1.93  |
    | 不可达节点比例       | 1.57% |
    | 平均邻居数           | 10.04 |

4. 跳数分布

    | 跳数             | 节点占比 |
    | ---------------- | -------- |
    | 0 (修复文件本身) | 0.15%    |
    | 1                | 2.22%    |
    | 2                | 71.86%   |
    | 3                | 23.74%   |
    | 4                | 0.46%    |
    | 5                | <0.01%   |
    | 不可达           | 1.57%    |

**评估结论**：AspectJ数据集具有良好的连通性（98.43%的节点可达修复文件），较短的平均路径长度（2.50），且71.86%的节点在2跳范围内可达修复文件，表明该数据集非常适合基于消息传递机制的GAT模型。图密度较低(0.0047)但每个节点平均有10.04个邻居，为消息传递提供了足够的通道。

### Tomcat数据集的图结构和消息传播特性评估结果

1. 基本统计

    | 指标              | 数值   |
    | ----------------- | ------ |
    | 总bug数           | 1045   |
    | 总文件数          | 16698  |
    | 修复文件比例      | 0.17%  |
    | 平均每个bug的边数 | 5012.1 |

2. 图结构特性

    | 指标             | 均值    | 标准差  |
    | ---------------- | ------- | ------- |
    | 节点数量         | 1150.68 | 236.86  |
    | 边数量           | 5011.30 | 1180.58 |
    | 图密度           | 0.0078  | 0.0013  |
    | 修复文件数       | 2.11    | 4.88    |
    | 连通分量数       | 57.40   | 3.32    |
    | 最大连通分量大小 | 1088.13 | 232.74  |
    | 平均路径长度     | 3.61    | 0.16    |
    | 消息传递效率     | 0.28    | 0.01    |

3. 消息传播特性

    | 指标                 | 数值  |
    | -------------------- | ----- |
    | 到修复文件的平均跳数 | 3.36  |
    | 不可达节点比例       | 8.29% |
    | 平均邻居数           | 8.66  |

4. 跳数分布

    | 跳数             | 节点占比 |
    | ---------------- | -------- |
    | 0 (修复文件本身) | 0.19%    |
    | 1                | 2.81%    |
    | 2                | 27.84%   |
    | 3                | 38.38%   |
    | 4                | 15.29%   |
    | 5                | 4.77%    |
    | 6                | 1.70%    |
    | 7                | 0.57%    |
    | 8                | 0.13%    |
    | 9                | 0.02%    |
    | 10               | <0.01%   |
    | 不可达           | 8.29%    |

**评估结论**：Tomcat数据集相比AspectJ具有更高的图密度(0.0078)和更大的平均路径长度(3.61)。虽然连通性略低(91.71%的节点可达修复文件)，但消息传递结构较丰富，大约66.22%的节点在2-3跳范围内可达修复文件，每个节点平均有8.66个邻居。这种图结构特性也适合GAT模型的消息传递机制，但可能需要处理更多跳距的信息传递。

## 模型训练与评估结果

### AspectJ数据集

1. 原始模型(SGDRegressor)结果

    | 属性        | 分数   |     | 属性        | 分数   |
    | ----------- | ------ | --- | ----------- | ------ |
    | Accuracy@1  | 0.1842 |     | Accuracy@11 | 0.6447 |
    | Accuracy@2  | 0.2895 |     | Accuracy@12 | 0.6579 |
    | Accuracy@3  | 0.3684 |     | Accuracy@13 | 0.6579 |
    | Accuracy@4  | 0.4079 |     | Accuracy@14 | 0.6711 |
    | Accuracy@5  | 0.4605 |     | Accuracy@15 | 0.6711 |
    | Accuracy@6  | 0.5000 |     | Accuracy@16 | 0.6711 |
    | Accuracy@7  | 0.5132 |     | Accuracy@17 | 0.6711 |
    | Accuracy@8  | 0.5921 |     | Accuracy@18 | 0.6711 |
    | Accuracy@9  | 0.6447 |     | Accuracy@19 | 0.6842 |
    | Accuracy@10 | 0.6447 |     | Accuracy@20 | 0.7105 |
    | MAP         | 0.2665 |     | MRR         | 0.3175 |

2. GAT模型(图注意力网络)结果

    | 属性        | 分数   |     | 属性        | 分数   |
    | ----------- | ------ | --- | ----------- | ------ |
    | Accuracy@1  | 0.2237 |     | Accuracy@11 | 0.6579 |
    | Accuracy@2  | 0.3026 |     | Accuracy@12 | 0.6711 |
    | Accuracy@3  | 0.3553 |     | Accuracy@13 | 0.6711 |
    | Accuracy@4  | 0.4605 |     | Accuracy@14 | 0.6842 |
    | Accuracy@5  | 0.4868 |     | Accuracy@15 | 0.6842 |
    | Accuracy@6  | 0.5000 |     | Accuracy@16 | 0.6842 |
    | Accuracy@7  | 0.5395 |     | Accuracy@17 | 0.6974 |
    | Accuracy@8  | 0.5789 |     | Accuracy@18 | 0.6974 |
    | Accuracy@9  | 0.6316 |     | Accuracy@19 | 0.7105 |
    | Accuracy@10 | 0.6579 |     | Accuracy@20 | 0.7237 |
    | MAP         | 0.2961 |     | MRR         | 0.3439 |

3. 模型性能对比分析

    | 模型         | MAP    | MRR    | Accuracy@1 | Accuracy@5 | Accuracy@10 | Accuracy@20 |
    | ------------ | ------ | ------ | ---------- | ---------- | ----------- | ----------- |
    | SGDRegressor | 0.2665 | 0.3175 | 0.1842     | 0.4605     | 0.6447      | 0.7105      |
    | GAT模型      | 0.2961 | 0.3439 | 0.2237     | 0.4868     | 0.6579      | 0.7237      |
    | 提升百分比   | 11.1%  | 8.3%   | 21.4%      | 5.7%       | 2.0%        | 1.9%        |

### Tomcat数据集

1. 原始模型(SGDRegressor)结果

    | 属性        | 分数   |     | 属性        | 分数   |
    | ----------- | ------ | --- | ----------- | ------ |
    | Accuracy@1  | 0.4294 |     | Accuracy@11 | 0.7101 |
    | Accuracy@2  | 0.5266 |     | Accuracy@12 | 0.7174 |
    | Accuracy@3  | 0.5780 |     | Accuracy@13 | 0.7229 |
    | Accuracy@4  | 0.6092 |     | Accuracy@14 | 0.7303 |
    | Accuracy@5  | 0.6294 |     | Accuracy@15 | 0.7358 |
    | Accuracy@6  | 0.6514 |     | Accuracy@16 | 0.7376 |
    | Accuracy@7  | 0.6679 |     | Accuracy@17 | 0.7431 |
    | Accuracy@8  | 0.6807 |     | Accuracy@18 | 0.7450 |
    | Accuracy@9  | 0.6954 |     | Accuracy@19 | 0.7486 |
    | Accuracy@10 | 0.7064 |     | Accuracy@20 | 0.7523 |
    | MAP         | 0.5275 |     | MRR         | 0.5232 |

2. 改进的GAT模型(图注意力网络)结果

    | 属性        | 分数   |     | 属性        | 分数   |
    | ----------- | ------ | --- | ----------- | ------ |
    | Accuracy@1  | 0.4550 |     | Accuracy@11 | 0.7284 |
    | Accuracy@2  | 0.5505 |     | Accuracy@12 | 0.7321 |
    | Accuracy@3  | 0.5872 |     | Accuracy@13 | 0.7376 |
    | Accuracy@4  | 0.6220 |     | Accuracy@14 | 0.7431 |
    | Accuracy@5  | 0.6550 |     | Accuracy@15 | 0.7505 |
    | Accuracy@6  | 0.6716 |     | Accuracy@16 | 0.7541 |
    | Accuracy@7  | 0.6899 |     | Accuracy@17 | 0.7560 |
    | Accuracy@8  | 0.7009 |     | Accuracy@18 | 0.7596 |
    | Accuracy@9  | 0.7064 |     | Accuracy@19 | 0.7615 |
    | Accuracy@10 | 0.7174 |     | Accuracy@20 | 0.7615 |
    | MAP         | 0.5482 |     | MRR         | 0.5445 |

3. 模型性能对比分析

    | 模型          | MAP    | MRR    | Accuracy@1 | Accuracy@5 | Accuracy@10 | Accuracy@20 |
    | ------------- | ------ | ------ | ---------- | ---------- | ----------- | ----------- |
    | SGDRegressor  | 0.5275 | 0.5232 | 0.4294     | 0.6294     | 0.7064      | 0.7523      |
    | 改进的GAT模型 | 0.5482 | 0.5445 | 0.4550     | 0.6550     | 0.7174      | 0.7615      |
    | 提升百分比    | 3.92%  | 4.07%  | 5.96%      | 4.07%      | 1.56%       | 1.22%       |

## 模型结果详细评估

### AspectJ数据集分析

对AspectJ数据集的模型评估结果表明，基于图注意力网络(GAT)的方法在缺陷文件定位任务中表现出色。

1. 模型性能比较（交叉验证得分）

    | 模型类别     | 平均得分 | 标准差 | 最低得分 | 最高得分 | 模型数量 |
    | ------------ | -------- | ------ | -------- | -------- | -------- |
    | baseline_mlp | 0.0905   | 0.0179 | 0.0779   | 0.1032   | 2        |
    | gat_realedge | 0.2816   | 0.0289 | 0.2383   | 0.2975   | 4        |
    | gat_selfloop | 0.1650   | 0.1336 | 0.0028   | 0.2748   | 4        |

2. 最佳模型分析

    - **最佳模型**: GATRegressor_MSE_16_l2_4_a0.0001_dr0.3_lr0.005
    - **类型**: GAT模型（使用真实依赖边）
    - **测试MAP得分**: 0.2961

3. 最优参数配置

    | 参数          | 最优值 | 说明                    |
    | ------------- | ------ | ----------------------- |
    | loss_type     | MSE    | 均方误差损失函数        |
    | hidden_dim    | 16     | 隐藏层维度              |
    | penalty       | l2     | L2正则化                |
    | learning_rate | 0.005  | 学习率                  |
    | dropout       | 0.3    | Dropout比例             |
    | alpha         | 0.0001 | 注意力机制LeakyReLU斜率 |

4. 主要发现

    1. **基于图结构的优势**：GAT模型(MAP=0.2816)显著优于基准MLP模型(MAP=0.0905)，证实了利用代码依赖图结构能有效提升缺陷文件定位性能。

    2. **真实边的重要性**：使用真实依赖边的GAT模型(MAP=0.2816)表现明显优于仅使用自环的GAT模型(MAP=0.1650)，表明代码间的依赖关系对于定位缺陷文件至关重要。

5. 与数据集特性的关联分析

    模型结果与数据集评估特性高度一致：

    - **高效的消息传递**：数据集中71.86%的节点在2跳范围内可达修复文件，与GAT模型的优异表现相符，因为GAT能有效聚合2-3跳范围内的邻居信息。

    - **连通性利用**：数据集具有98.43%的节点可达修复文件的良好连通性，GAT模型通过注意力机制有效利用了这一特性，使得模型能够关注到重要的结构信息。

    - **密度与邻居数平衡**：每个节点平均有10.04个邻居，提供了足够的信息传递通道，同时又不会导致过度稠密而引入噪声，使GAT的注意力机制能够有效地筛选重要节点。

### Tomcat数据集分析

对Tomcat数据集的模型评估结果显示，GAT模型在该数据集上表现与基准模型相当，但在某些指标上有所提升。

1. 模型性能比较（交叉验证得分）

    | 模型类别     | 平均得分 | 标准差 | 最低得分 | 最高得分 | 模型数量 |
    | ------------ | -------- | ------ | -------- | -------- | -------- |
    | baseline_mlp | 0.2944   | 0.1766 | 0.0117   | 0.4843   | 8        |
    | gat_realedge | 0.3250   | 0.1974 | 0.0077   | 0.5356   | 24       |
    | gat_selfloop | 0.3955   | 0.1872 | 0.0107   | 0.5589   | 24       |

2. 最佳模型分析

    - **最佳模型**: GATRegressor_MSE_32_l2_4_a0.0001_dr0.3_lr0.005_selfloop
    - **类型**: GAT模型（仅自环）
    - **测试MAP得分**: 0.5407

3. 最优参数配置

    | 参数          | 最优值 | 说明                    |
    | ------------- | ------ | ----------------------- |
    | loss_type     | MSE    | 均方误差损失函数        |
    | hidden_dim    | 32     | 隐藏层维度              |
    | penalty       | l2     | L2正则化                |
    | learning_rate | 0.005  | 学习率                  |
    | dropout       | 0.3    | Dropout比例             |
    | alpha         | 0.0001 | 注意力机制LeakyReLU斜率 |

4. 主要发现

    1. **模型性能差异较小**：在Tomcat数据集上，GAT模型(MAP=0.3250)与基准MLP模型(MAP=0.2944)性能相近，提升较为有限。

    2. **真实边没有价值**：使用真实依赖边的GAT模型(MAP=0.3250)弱于仅使用自环的GAT模型(MAP=0.3955)。

5. 与数据集特性的关联分析

    Tomcat数据集上的模型表现与其图结构特性密切相关：

    - **更长的消息传递路径**：Tomcat数据集中仅30.65%的节点在2跳范围内可达修复文件，大部分节点(38.38%)需要3跳才能到达，这增加了消息传递的难度。

    - **较低的连通性**：Tomcat的节点可达性为91.71%，低于AspectJ的98.43%，这意味着部分节点无法从修复文件获取信息。

    - **更多的连通分量**：Tomcat平均有57.40个连通分量，远高于AspectJ的18.28个，导致图结构更为分散，不利于全局消息传递。
